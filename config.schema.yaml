$schema: https://yaml-schema.net/yaml-config.schema.yaml
$id: https://floe.local/schema/config-v0.1

title: Floe Config v0.1

type: object
additionalProperties: false
required:
  - version
  - entities

properties:
  version:
    type: string
  metadata:
    $ref: "#/$defs/project_metadata"
  storages:
    $ref: "#/$defs/storages"
  report:
    $ref: "#/$defs/report"
  entities:
    type: array
    items:
      $ref: "#/$defs/entity"

$defs:
  project_metadata:
    type: object
    additionalProperties: false
    required:
      - project
    properties:
      project:
        type: string
      description:
        type: string
      owner:
        type: string
      tags:
        type: array
        items:
          type: string

  entity:
    allOf:
      - $ref: "#/$defs/entity_base"
      - oneOf:
          - $ref: "#/$defs/entity_reject"
          - $ref: "#/$defs/entity_non_reject"

  entity_base:
    type: object
    additionalProperties: false
    required:
      - name
      - source
      - sink
      - policy
      - schema
    properties:
      name:
        type: string
      metadata:
        $ref: "#/$defs/entity_metadata"
      source:
        $ref: "#/$defs/source"
      sink:
        $ref: "#/$defs/sink"
      policy:
        $ref: "#/$defs/policy"
      schema:
        $ref: "#/$defs/schema"

  entity_reject:
    type: object
    properties:
      policy:
        type: object
        properties:
          severity:
            const: reject
      sink:
        type: object
        required:
          - rejected

  entity_non_reject:
    type: object
    properties:
      policy:
        type: object
        properties:
          severity:
            enum: [warn, abort]

  entity_metadata:
    type: object
    additionalProperties: false
    properties:
      data_product:
        type: string
      domain:
        type: string
      owner:
        type: string
      description:
        type: string
      tags:
        type: array
        items:
          type: string

  source:
    type: object
    additionalProperties: false
    required:
      - format
      - path
    properties:
      format:
        type: string
        enum: [csv, parquet, json]
      path:
        type: string
      storage:
        type: string
      options:
        $ref: "#/$defs/source_options"
      cast_mode:
        type: string
        enum: [strict, coerce]

  source_options:
    type: object
    additionalProperties: false
    properties:
      header:
        type: boolean
      separator:
        type: string
      encoding:
        type: string
      null_values:
        type: array
        items:
          type: string
      recursive:
        type: boolean
      glob:
        type: string
      ndjson:
        type: boolean

  sink:
    type: object
    additionalProperties: false
    required:
      - accepted
    properties:
      accepted:
        $ref: "#/$defs/sink_accepted"
      rejected:
        $ref: "#/$defs/sink_rejected"
      archive:
        $ref: "#/$defs/archive_target"

  sink_accepted:
    type: object
    additionalProperties: false
    required:
      - format
      - path
    properties:
      format:
        type: string
        enum: [parquet, delta]
      path:
        type: string
      storage:
        type: string
      options:
        type: object
        additionalProperties: false
        properties:
          compression:
            type: string
            enum: [snappy, gzip, zstd, uncompressed]
          row_group_size:
            type: integer
            minimum: 1

  sink_rejected:
    type: object
    additionalProperties: false
    required:
      - format
      - path
    properties:
      format:
        type: string
        enum: [csv]
      path:
        type: string
      storage:
        type: string

  report:
    type: object
    additionalProperties: false
    required:
      - path
    properties:
      path:
        type: string
      formatter:
        type: string
        enum: [json, csv, text]

  storages:
    type: object
    additionalProperties: false
    required:
      - default
      - definitions
    properties:
      default:
        type: string
      definitions:
        type: array
        items:
          $ref: "#/$defs/storage_definition"

  storage_definition:
    type: object
    additionalProperties: false
    required:
      - name
      - type
    properties:
      name:
        type: string
      type:
        type: string
        enum: [local, s3]
      bucket:
        type: string
      region:
        type: string
      prefix:
        type: string

  archive_target:
    type: object
    additionalProperties: false
    required:
      - path
    properties:
      path:
        type: string

  policy:
    type: object
    additionalProperties: false
    required:
      - severity
    properties:
      severity:
        type: string
        enum: [warn, reject, abort]

  schema:
    type: object
    additionalProperties: false
    required:
      - columns
    properties:
      normalize_columns:
        $ref: "#/$defs/normalize_columns"
      mismatch:
        $ref: "#/$defs/schema_mismatch"
      columns:
        type: array
        items:
          $ref: "#/$defs/column"

  normalize_columns:
    type: object
    additionalProperties: false
    properties:
      enabled:
        type: boolean
      strategy:
        type: string
        enum: [snake_case, lower, camel_case, none]

  schema_mismatch:
    type: object
    additionalProperties: false
    properties:
      missing_columns:
        type: string
        enum: [reject_file, fill_nulls]
      extra_columns:
        type: string
        enum: [reject_file, ignore]

  column:
    type: object
    additionalProperties: false
    required:
      - name
      - type
    properties:
      name:
        type: string
      type:
        type: string
        enum: [string, integer, number, float, decimal, boolean, date, datetime]
      nullable:
        type: boolean
      unique:
        type: boolean
